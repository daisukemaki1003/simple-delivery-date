## このドキュメントの目的
- 「配送日時指定カレンダー付きのShopifyアプリ」を開発・運用する際に迷わないよう、ローカル環境のセットアップと主要コマンドをまとめました。
- Shopify CLI 前提のテンプレート（React Router + Vite + Prisma/SQLite）です。CLIが環境変数の注入やトンネル開設を担います。

## 前提・技術スタック
- Node.js: `>=20.19 <22 || >=22.12`（`node -v`で確認、nvm/volta推奨）
- パッケージ: npm（`package-lock.json`あり）。グローバルに `@shopify/cli@latest` が必要。
- フレームワーク: React 18 + React Router 7、Viteビルド。
- サーバー/認証: `@shopify/shopify-app-react-router` (`app/shopify.server.ts`)。埋め込みアプリ想定。
- DB: Prisma + SQLite (`prisma/schema.prisma` の `dev.sqlite`)。セッション永続化用。
- 型/品質: TypeScript (strict), ESLint (`npm run lint`), TypeGen (`react-router typegen`), Prettierは明示設定なし（エディタのデフォルトでOK）。

## ディレクトリの目印
- `app/`…ルートとサーバー設定一式。Shopify連携は `shopify.server.ts`。
- `prisma/`…`schema.prisma` と生成物 (`dev.sqlite`, migrations)。
- `extensions/`…拡張機能置き場（現状 `.gitkeep` のみ）。
- `doc/`…この資料。
- `.shopify/`…CLIが作る認証情報/環境変数。**手動でコミットしないこと。**
- `shopify.app.toml`…アプリ名、スコープ (`write_products`), Webhook (`app/uninstalled` など)。
- `shopify.web.toml`…`predev`/`dev` コマンドのフック。

## 初期セットアップ
1) Node を対応バージョンに合わせる。  
2) 依存を取得: `npm install`  
3) Shopify CLI をログイン/リンク（初回のみ）: `npm run dev` を叩くと対話的に Partner アカウント・開発ストアを選択。`.env` 相当の値は CLI が `.shopify/` に保存。  
4) DB 初期化は `shopify.web.toml` の `predev` (`npx prisma generate`) と `dev` (`npx prisma migrate deploy`) が自動実行されるので基本不要。手動で行う場合は `npm run setup`。

## 日常のコマンド
- `npm run dev` … Shopify CLI 付き開発サーバー起動。ポートは `PORT`（未設定なら3000）/ HMR 64999。`P` でアプリURLを開く。
- `npm run lint` … ESLint。`.gitignore` を無視対象に使用。
- `npm run typecheck` … React Router TypeGen + `tsc --noEmit`。
- `npm run build` … プロダクションビルド。
- `npm run start` … ビルド済みサーバーを `react-router-serve ./build/server/index.js` で起動。
- `npm run deploy` … Shopify CLI の `app deploy`。App toml を同期し、Webhook を更新。
- `npm run graphql-codegen` … Admin API 型生成（`app/types` に出力）。
- `npm run setup` … `prisma generate && prisma migrate deploy`（DB準備だけ行いたいとき）。

## 環境変数とポート
- `SHOPIFY_APP_URL` … 公開URL（CLIがトンネルURLを注入）。`HOST` が渡された場合は `vite.config.ts` 内で上書きされる。
- `PORT` … Vite/バックエンドの待受。デフォルト3000。
- `FRONTEND_PORT` … 埋め込みで localhost 以外のときの HMR ポート（デフォルト8002）。
- `NODE_ENV` … Dockerfile では `production` 固定。
- Prismaの `DATABASE_URL` は未使用で、`schema.prisma` の `file:dev.sqlite` を参照。別DBを使う場合はここを差し替え。
（補足）CLI が生成する `.env` は `.shopify` 下に配置され、Git 管理外。

## Docker で試す場合
- ビルド: `docker build -t simple-delivery-date .`
- 起動: `docker run --rm -p 3000:3000 --env-file .shopify/.env simple-delivery-date`
- コンテナ内では `npm run docker-start` → `npm run setup` + `npm run start`。SQLite はコンテナ内に作られるため、永続化したい場合はボリュームで `/app/prisma` をマウント。

## 開発時の注意メモ
- 埋め込みアプリでは `<Link>` を使う（`a` タグ直書きや `redirect` from react-router は避け、`authenticate.admin` が返す `redirect` を利用）。
- GraphQL Admin API のスキーマバージョンは `.graphqlrc.ts` で `ApiVersion.October25` に固定。変更時は Codegen も走らせる。
- HMR 周りで `HOST` を渡されたときにエラーになる場合は、`SHOPIFY_APP_URL` を明示セットするか `vite.config.ts` のコメントを参照。
- テストスイートは現状なし。開発完了時は少なくとも `npm run lint` と `npm run typecheck` を実行し、画面確認まで済ませると安全。
